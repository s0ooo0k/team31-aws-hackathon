<!doctype html>
<html>
  <head>
    <title>Nova English Learning - Study</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="/socket.io/socket.io.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: #f8fafc;
        min-height: 100vh;
      }

      .header {
        background: white;
        padding: 15px 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .header-content {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo h1 {
        color: #667eea;
        font-size: 20px;
        font-weight: 700;
      }

      .session-info {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .timer {
        color: #64748b;
        font-weight: 500;
      }

      .back-btn {
        padding: 8px 16px;
        background: #f1f5f9;
        color: #64748b;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        text-decoration: none;
      }

      .study-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        height: calc(100vh - 80px);
      }

      .left-panel {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .right-panel {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .image-section {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      }

      .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 15px;
      }

      .original-image {
        width: 100%;
        border-radius: 8px;
        margin-bottom: 15px;
      }

      .image-info {
        background: #f8fafc;
        padding: 15px;
        border-radius: 8px;
        font-size: 14px;
        color: #64748b;
      }

      .generated-image-section {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        flex: 1;
      }

      .generated-image-placeholder {
        width: 100%;
        height: 300px;
        background: #f1f5f9;
        border: 2px dashed #cbd5e1;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748b;
        font-size: 16px;
      }

      .generated-image {
        width: 100%;
        border-radius: 8px;
        display: none;
      }

      .conversation-section {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      .chat-container {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 20px;
        max-height: 400px;
      }

      .message {
        margin-bottom: 15px;
        padding: 12px 16px;
        border-radius: 12px;
        max-width: 80%;
      }

      .message.user {
        background: #667eea;
        color: white;
        margin-left: auto;
      }

      .message.assistant {
        background: #f1f5f9;
        color: #1e293b;
      }

      .message.thinking {
        background: #fef3c7;
        color: #92400e;
        font-style: italic;
      }

      .role-label {
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 4px;
        opacity: 0.7;
      }

      .controls-section {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      }

      .audio-controls {
        display: flex;
        gap: 15px;
        align-items: center;
        justify-content: center;
      }

      .control-btn {
        padding: 15px 25px;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 120px;
      }

      .start-btn {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
      }

      .start-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
      }

      .stop-btn {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
      }

      .stop-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
      }

      .control-btn:disabled {
        background: #e2e8f0;
        color: #94a3b8;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .status {
        text-align: center;
        margin-top: 15px;
        padding: 10px;
        border-radius: 8px;
        font-weight: 500;
      }

      .status.ready {
        background: #dcfce7;
        color: #166534;
      }

      .status.recording {
        background: #fef3c7;
        color: #92400e;
      }

      .status.processing {
        background: #dbeafe;
        color: #1d4ed8;
      }

      .status.error {
        background: #fee2e2;
        color: #991b1b;
      }

      .finish-btn {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 20px;
        transition: all 0.3s ease;
      }

      .finish-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      }

      @media (max-width: 1024px) {
        .study-container {
          grid-template-columns: 1fr;
          height: auto;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="header-content">
        <div class="logo">
          <h1>Nova English Study</h1>
        </div>
        <div class="session-info">
          <div class="timer" id="timer">00:00</div>
          <a href="/categories" class="back-btn">â† Back to Categories</a>
        </div>
      </div>
    </div>

    <div class="study-container">
      <div class="left-panel">
        <div class="image-section">
          <div class="section-title">Original Image</div>
          <img
            id="original-image"
            class="original-image"
            src=""
            alt="Study image"
          />
          <div class="image-info" id="image-info">
            Loading image information...
          </div>
        </div>

        <div class="generated-image-section">
          <div class="section-title">
            ğŸ¨ AI Generated Image (Real-time from Your Speech)
          </div>
          <div class="generated-image-placeholder" id="generated-placeholder">
            ğŸ¤ Start speaking to automatically generate images based on your
            description!
          </div>
          <img
            id="generated-image"
            class="generated-image"
            src=""
            alt="Generated image"
          />
        </div>
      </div>

      <div class="right-panel">
        <div class="conversation-section">
          <div class="section-title">Conversation with Nova Tutor</div>
          <div class="chat-container" id="chat-container">
            <div class="message assistant">
              <div class="role-label">NOVA TUTOR</div>
              <div>
                Hello! I'm your English tutor. Look at the image on the left and
                start describing what you see. I'll help you make your
                description more detailed and specific!
              </div>
            </div>
          </div>
        </div>

        <div class="controls-section">
          <div class="section-title">Voice Controls</div>
          <div class="audio-controls">
            <button id="start-btn" class="control-btn start-btn">
              ğŸ¤ Start Speaking
            </button>
            <button id="stop-btn" class="control-btn stop-btn" disabled>
              â¹ï¸ Stop
            </button>
          </div>
          <div id="status" class="status ready">
            Ready to start! Click "Start Speaking" and describe the image.
          </div>
          <button id="finish-btn" class="finish-btn">
            âœ… Finish Session & Get Evaluation
          </button>
        </div>
      </div>
    </div>

    <script>
      // ì „ì—­ ë³€ìˆ˜
      let socket;
      let audioContext;
      let audioStream;
      let processor;
      let sourceNode;
      let isStreaming = false;
      let sessionInitialized = false;
      let startTime;
      let timerInterval;
      let conversationHistory = [];
      let currentImage = null;
      let samplingRatio = 1;
      const TARGET_SAMPLE_RATE = 16000;
      const isFirefox = navigator.userAgent.toLowerCase().includes("firefox");

      // ì´ë¯¸ì§€ ìƒì„± ê´€ë ¨ ë³€ìˆ˜
      let userMessages = [];
      let imageGenerationTimer;
      let isGeneratingImage = false;
          
      // Setì„ ì´ìš©í•œ ì¤‘ë³µ ë©”ì‹œì§€ ë°©ì§€
      let lastProcessedMessages = new Set();

      console.log("ğŸ”§ Frontend: Image generation variables initialized");

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
      document.addEventListener("DOMContentLoaded", async () => {
        // ë¡œê·¸ì¸ í™•ì¸
        const user = JSON.parse(localStorage.getItem("user") || "null");
        if (!user) {
          window.location.href = "/login";
          return;
        }

        // URLì—ì„œ ì¹´í…Œê³ ë¦¬ ê°€ì ¸ì˜¤ê¸°
        const urlParams = new URLSearchParams(window.location.search);
        const categoryId =
          urlParams.get("category") || localStorage.getItem("selectedCategory");

        if (!categoryId) {
          window.location.href = "/categories";
          return;
        }

        // ì´ˆê¸°í™”
        await initializeStudySession(categoryId);
        setupEventListeners();
        startTimer();
      });

      async function initializeStudySession(categoryId) {
        try {
          // ëœë¤ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
          const response = await fetch("/api/images/random");
          const result = await response.json();

          if (result.success) {
            currentImage = result.data;
            displayImage(currentImage);

            // Socket.IO ì—°ê²°
            socket = io();
            setupSocketEvents();

            // ì˜¤ë””ì˜¤ ì´ˆê¸°í™”
            await initAudio();

            // ê³µì‹ AudioPlayer ì´ˆê¸°í™”
            const { AudioPlayer } = await import("/js/AudioPlayer.js");
            window.audioPlayer = new AudioPlayer();
            await window.audioPlayer.start();
            console.log("Official AudioPlayer initialized");
          } else {
            throw new Error("Failed to load image");
          }
        } catch (error) {
          console.error("Error initializing study session:", error);
          document.getElementById("status").textContent =
            "Error loading study session";
          document.getElementById("status").className = "status error";
        }
      }

      function displayImage(imageData) {
        const img = document.getElementById("original-image");
        const info = document.getElementById("image-info");

        img.src = imageData.url;
        info.innerHTML = `
                <strong>Category:</strong> ${imageData.category}<br>
                <strong>Description:</strong> ${imageData.description}<br>
                <strong>Expected Vocabulary:</strong> ${imageData.expectedVocabulary.join(", ")}
            `;
      }

      function setupSocketEvents() {
        socket.on("connect", () => {
          console.log("Connected to server");
          document.getElementById("status").textContent =
            "Connected! Ready to start.";
          document.getElementById("status").className = "status ready";
        });

        socket.on("textOutput", (data) => {
          console.log("Text output:", data);

          // interrupted ë©”ì‹œì§€ëŠ” UIì— í‘œì‹œí•˜ì§€ ì•ŠìŒ
          if (
            data.content &&
            data.content.toLowerCase().includes("interrupted")
          ) {
            console.log("Filtered out interrupted message:", data.content);
            return;
          }

          // JSON í˜•íƒœì˜ interrupted ë©”ì‹œì§€ í•„í„°ë§
          try {
            const parsed = JSON.parse(data.content);
            if (parsed.interrupted === true) {
              console.log("Filtered out JSON interrupted message");
              return;
            }
          } catch (e) {
            // JSONì´ ì•„ë‹Œ ê²½ìš° ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰
          }

          // AI ë©”ì‹œì§€ë§Œ ì¶”ê°€ (ì‚¬ìš©ì ë©”ì‹œì§€ëŠ” userTextDetectedì—ì„œ ì²˜ë¦¬)
          // Setì„ ì´ìš©í•œ ì¤‘ë³µ ë°©ì§€ëŠ” addMessageToChat ë‚´ë¶€ì—ì„œ ì²˜ë¦¬
          if (data.role === "ASSISTANT") {
            addMessageToChat("assistant", data.content);
          }
          // USER ë©”ì‹œì§€ëŠ” ë¬´ì‹œ (ì¤‘ë³µ ë°©ì§€)
        });

        socket.on("audioOutput", (data) => {
          if (data.content && window.audioPlayer) {
            playAudio(data.content);
          }
        });

        socket.on("contentStart", (data) => {
          console.log("Content start:", data);
        });

        socket.on("contentEnd", (data) => {
          console.log("Content end:", data);

          // Java ìƒ˜í”Œê³¼ ë™ì¼í•œ barge-in ì²˜ë¦¬
          if (data.type === "TEXT") {
            if (
              data.stopReason &&
              data.stopReason.toUpperCase() === "END_TURN"
            ) {
              console.log("Turn ended normally");
            } else if (
              data.stopReason &&
              data.stopReason.toUpperCase() === "INTERRUPTED"
            ) {
              console.log("AI speech interrupted by user (barge-in)");
              if (window.audioPlayer) {
                window.audioPlayer.bargeIn();
              }
            }
          }
        });

        socket.on("error", (error) => {
          console.error("Socket error:", error);
          document.getElementById("status").textContent =
            "Error: " + error.message;
          document.getElementById("status").className = "status error";
        });

        // ì‚¬ìš©ì í…ìŠ¤íŠ¸ ê°ì§€ ìˆ˜ì‹  (Setì„ ì´ìš©í•œ ì¤‘ë³µ ë°©ì§€)
        socket.on("userTextDetected", (data) => {
          console.log("ğŸ‘¤ Frontend: User text detected:", data.text);
          console.log("ğŸ“ Frontend: Full buffer:", data.fullBuffer);

          // Setì„ ì´ìš©í•œ ì¤‘ë³µ ë°©ì§€ëŠ” addMessageToChat ë‚´ë¶€ì—ì„œ ì²˜ë¦¬
          addMessageToChat("user", data.text);
        });

        // ì´ë¯¸ì§€ ìƒì„± ê²°ê³¼ ìˆ˜ì‹ 
        socket.on("imageGenerated", (data) => {
          console.log("ğŸ¨ Frontend: Image generation result received:", data);
          console.log("ğŸ”§ Frontend: Setting isGeneratingImage to false");
          isGeneratingImage = false;

          if (data.success) {
            console.log("âœ… Frontend: Image generated successfully!");
            if (data.isAutoGenerated) {
              console.log("ğŸ¤– Frontend: Auto-generated image");
              displayGeneratedImage(data.imageUrl, data.originalText, true);
              showAutoGenerationNotice(data.originalText);
            } else {
              console.log("ğŸ‘¤ Frontend: Manual generated image");
              displayGeneratedImage(data.imageUrl, data.prompt);
            }
          } else {
            console.error("âŒ Frontend: Image generation failed:", data.error);
            showImageGenerationError();
          }

          console.log("ğŸ”§ Frontend: Ready for next image generation");
        });
      }

      async function initAudio() {
        try {
          document.getElementById("status").textContent =
            "Requesting microphone access...";

          audioStream = await navigator.mediaDevices.getUserMedia({
            audio: {
              echoCancellation: true,
              noiseSuppression: true,
              autoGainControl: true,
            },
          });

          // ê³µì‹ ìƒ˜í”Œ ì½”ë“œì™€ ë™ì¼í•œ ì„¤ì •
          const isFirefox = navigator.userAgent
            .toLowerCase()
            .includes("firefox");

          if (isFirefox) {
            audioContext = new AudioContext();
          } else {
            audioContext = new AudioContext({
              sampleRate: 16000,
            });
          }

          const samplingRatio = audioContext.sampleRate / 16000;
          console.log(
            `AudioContext sampleRate: ${audioContext.sampleRate}, samplingRatio: ${samplingRatio}`
          );

          document.getElementById("status").textContent =
            'Microphone ready! Click "Start Speaking" to begin.';
          document.getElementById("status").className = "status ready";
        } catch (error) {
          console.error("Error accessing microphone:", error);
          document.getElementById("status").textContent =
            "Error: " + error.message;
          document.getElementById("status").className = "status error";
        }
      }

      function setupEventListeners() {
        document
          .getElementById("start-btn")
          .addEventListener("click", startRecording);
        document
          .getElementById("stop-btn")
          .addEventListener("click", stopRecording);
        document
          .getElementById("finish-btn")
          .addEventListener("click", finishSession);
      }

      async function startRecording() {
        if (isStreaming) return;

        try {
          // ì„¸ì…˜ ì´ˆê¸°í™”
          if (!sessionInitialized) {
            await initializeNovaSession();
          }

          // audioContextê°€ ì—†ìœ¼ë©´ ì˜¤ë””ì˜¤ ì¬ì´ˆê¸°í™”
          if (!audioContext || !audioStream) {
            console.log("ğŸ”„ Re-initializing audio...");
            await initAudio();
          }

          // ì˜¤ë””ì˜¤ ì²˜ë¦¬ ì‹œì‘ - ì‘ì€ ë²„í¼ë¡œ ì§€ì—°ì‹œê°„ ìµœì†Œí™”
          sourceNode = audioContext.createMediaStreamSource(audioStream);
          processor = audioContext.createScriptProcessor(1024, 1, 1);

          processor.onaudioprocess = (e) => {
            if (!isStreaming) return;

            const inputData = e.inputBuffer.getChannelData(0);
            const numSamples = Math.round(inputData.length / samplingRatio);
            const pcmData = isFirefox
              ? new Int16Array(numSamples)
              : new Int16Array(inputData.length);

            // ê³µì‹ ìƒ˜í”Œ ì½”ë“œì™€ ë™ì¼í•œ ì²˜ë¦¬
            if (isFirefox) {
              for (let i = 0; i < inputData.length; i++) {
                pcmData[i] =
                  Math.max(-1, Math.min(1, inputData[i * samplingRatio])) *
                  0x7fff;
              }
            } else {
              for (let i = 0; i < inputData.length; i++) {
                pcmData[i] = Math.max(-1, Math.min(1, inputData[i])) * 0x7fff;
              }
            }

            const base64Data = arrayBufferToBase64(pcmData.buffer);
            socket.emit("audioInput", base64Data);
          };

          sourceNode.connect(processor);
          processor.connect(audioContext.destination);

          isStreaming = true;
          document.getElementById("start-btn").disabled = true;
          document.getElementById("stop-btn").disabled = false;
          document.getElementById("status").textContent =
            "Listening... Describe what you see!";
          document.getElementById("status").className = "status recording";
        } catch (error) {
          console.error("Error starting recording:", error);
          document.getElementById("status").textContent =
            "Error: " + error.message;
          document.getElementById("status").className = "status error";
        }
      }

      function stopRecording() {
        if (!isStreaming) return;

        isStreaming = false;

        if (processor) {
          processor.disconnect();
          sourceNode.disconnect();
        }

        // ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ ì¤‘ë‹¨í•  ë•Œ barge-in ì²˜ë¦¬
        if (window.audioPlayer) {
          window.audioPlayer.bargeIn();
        }

        document.getElementById("start-btn").disabled = false;
        document.getElementById("stop-btn").disabled = true;
        document.getElementById("status").textContent = "Processing...";
        document.getElementById("status").className = "status processing";

        socket.emit("stopAudio");
      }

      async function initializeNovaSession() {
        if (sessionInitialized) return;

        try {
          const contextualPrompt = `You are an English conversation tutor helping a user describe an image.

Image Context: ${currentImage.description}
Expected Vocabulary: ${currentImage.expectedVocabulary.join(", ")}
Guiding Questions: ${currentImage.guidingQuestions.join(", ")}

Your role:
- Ask ONE specific follow-up question at a time
- Focus on visual details they haven't mentioned
- Keep responses short (1-2 sentences)
- Be encouraging and supportive
- Help them use more descriptive vocabulary

Start by encouraging them to describe what they see.`;

          socket.emit("promptStart");
          socket.emit("systemPrompt", contextualPrompt);
          socket.emit("audioStart");

          sessionInitialized = true;
          document.getElementById("status").textContent =
            "Session initialized! Ready to start.";
          document.getElementById("status").className = "status ready";

          // ì´ë¯¸ì§€ ìƒì„± íƒ€ì´ë¨¸ ì‹œì‘
          startImageGeneration();
        } catch (error) {
          console.error("Failed to initialize Nova session:", error);
          throw error;
        }
      }

      function addMessageToChat(role, message) {
        // ë¹ˆ ë©”ì‹œì§€ë‚˜ interrupted ë©”ì‹œì§€ í•„í„°ë§
        if (
          !message ||
          message.trim() === "" ||
          message.toLowerCase().includes("interrupted") ||
          message === '{ "interrupted" : true }' ||
          message === '{"interrupted":true}'
        ) {
          console.log("Filtered message:", message);
          return;
        }

        // Setì„ ì´ìš©í•œ ì¤‘ë³µ ë©”ì‹œì§€ ë°©ì§€
        const messageKey = `${role}:${message.trim()}`;
        if (lastProcessedMessages.has(messageKey)) {
          console.log("Duplicate message filtered with Set:", messageKey);
          return;
        }
        
        // ë©”ì‹œì§€ í‚¤ë¥¼ Setì— ì¶”ê°€
        lastProcessedMessages.add(messageKey);
        
        // Set í¬ê¸° ì œí•œ (ë©”ëª¨ë¦¬ ì ˆì•½)
        if (lastProcessedMessages.size > 20) {
          const firstKey = Array.from(lastProcessedMessages)[0];
          lastProcessedMessages.delete(firstKey);
        }

        const chatContainer = document.getElementById("chat-container");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${role}`;

        const roleLabel = document.createElement("div");
        roleLabel.className = "role-label";
        roleLabel.textContent = role === "assistant" ? "NOVA TUTOR" : "YOU";

        const content = document.createElement("div");
        content.textContent = message;

        messageDiv.appendChild(roleLabel);
        messageDiv.appendChild(content);
        chatContainer.appendChild(messageDiv);

        // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
        chatContainer.scrollTop = chatContainer.scrollHeight;

        // ëŒ€í™” ê¸°ë¡ì— ì¶”ê°€
        conversationHistory.push({
          role: role,
          message: message,
          timestamp: new Date().toISOString(),
        });

        console.log(`âœ… Message added to chat: ${role} - ${message.substring(0, 50)}...`);
      }

      // ìë™ ì´ë¯¸ì§€ ìƒì„± ì‹œì‘ (ì„œë²„ì—ì„œ ì‚¬ìš©ì ë°œí™” ì¢…ë£Œ ì‹œ ìë™ ì²˜ë¦¬)
      function startImageGeneration() {
        console.log(
          "Auto image generation enabled - images will be generated automatically when user stops speaking"
        );
      }

      // Nova Canvasë¡œ ì´ë¯¸ì§€ ìƒì„±
      function generateImageFromUserMessages(prompt) {
        if (isGeneratingImage) {
          console.log("Image generation already in progress, skipping...");
          return;
        }

        isGeneratingImage = true;
        console.log("Generating image with prompt:", prompt);

        // ìƒì„± ì¤‘ í‘œì‹œ
        showImageGenerationProgress();

        // Socketì„ í†µí•´ ì´ë¯¸ì§€ ìƒì„± ìš”ì²­
        socket.emit("generateImage", { prompt: prompt });
      }

      // ìƒì„±ëœ ì´ë¯¸ì§€ í‘œì‹œ
      function displayGeneratedImage(imageUrl, prompt, isAuto = false) {
        console.log("ğŸ–¼ï¸ Frontend: Displaying generated image...");
        console.log("ğŸ”— Frontend: Image URL length:", imageUrl.length);
        console.log("ğŸ“ Frontend: Prompt:", prompt);

        const placeholder = document.getElementById("generated-placeholder");
        const generatedImg = document.getElementById("generated-image");

        placeholder.style.display = "none";
        generatedImg.src = imageUrl;
        generatedImg.style.display = "block";

        // ìƒì„±ëœ ì´ë¯¸ì§€ URL ì €ì¥
        currentImage.generatedImageUrl = imageUrl;
        currentImage.generatedPrompt = prompt;
        currentImage.isAutoGenerated = isAuto;

        console.log(
          `âœ… Frontend: Generated image displayed successfully (${isAuto ? "auto" : "manual"})`
        );
      }

      // ìë™ ìƒì„± ì•Œë¦¼ í‘œì‹œ
      function showAutoGenerationNotice(userText) {
        const chatContainer = document.getElementById("chat-container");
        const noticeDiv = document.createElement("div");
        noticeDiv.className = "message thinking";

        const content = document.createElement("div");
        content.innerHTML = `ğŸ¨ <strong>AI Image Generated!</strong><br>Based on: "${userText}"`;

        noticeDiv.appendChild(content);
        chatContainer.appendChild(noticeDiv);

        // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
        chatContainer.scrollTop = chatContainer.scrollHeight;

        // 3ì´ˆ í›„ ìë™ ì‚­ì œ
        setTimeout(() => {
          if (noticeDiv.parentNode) {
            noticeDiv.parentNode.removeChild(noticeDiv);
          }
        }, 3000);
      }

      // ì´ë¯¸ì§€ ìƒì„± ì§„í–‰ ìƒíƒœ í‘œì‹œ
      function showImageGenerationProgress() {
        const placeholder = document.getElementById("generated-placeholder");
        placeholder.innerHTML =
          "ğŸ¨ Generating AI image based on your description...";
        placeholder.style.color = "#667eea";
      }

      // ì´ë¯¸ì§€ ìƒì„± ì˜¤ë¥˜ í‘œì‹œ
      function showImageGenerationError() {
        const placeholder = document.getElementById("generated-placeholder");
        placeholder.innerHTML =
          "âŒ Failed to generate image. Keep describing and we'll try again!";
        placeholder.style.color = "#ef4444";

        // 3ì´ˆ í›„ ì›ë˜ ë©”ì‹œì§€ë¡œ ë³µì›
        setTimeout(() => {
          placeholder.innerHTML =
            "Start describing the image above to generate an AI image based on your words!";
          placeholder.style.color = "#64748b";
        }, 3000);
      }

      function arrayBufferToBase64(buffer) {
        const binary = [];
        const bytes = new Uint8Array(buffer);
        for (let i = 0; i < bytes.byteLength; i++) {
          binary.push(String.fromCharCode(bytes[i]));
        }
        return btoa(binary.join(""));
      }

      function playAudio(base64Data) {
        try {
          // ê³µì‹ ìƒ˜í”Œ ì½”ë“œì™€ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬
          const binaryString = window.atob(base64Data);
          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }

          const int16Array = new Int16Array(bytes.buffer);
          const float32Array = new Float32Array(int16Array.length);
          for (let i = 0; i < int16Array.length; i++) {
            float32Array[i] = int16Array[i] / 32768.0;
          }

          if (window.audioPlayer && float32Array.length > 0) {
            window.audioPlayer.playAudio(float32Array);
          }
        } catch (error) {
          console.error("Error processing audio data:", error);
        }
      }

      function startTimer() {
        startTime = Date.now();
        timerInterval = setInterval(() => {
          const elapsed = Date.now() - startTime;
          const minutes = Math.floor(elapsed / 60000);
          const seconds = Math.floor((elapsed % 60000) / 1000);
          document.getElementById("timer").textContent =
            `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
        }, 1000);
      }

      function finishSession() {
        // íƒ€ì´ë¨¸ ì •ì§€
        if (timerInterval) {
          clearInterval(timerInterval);
        }

        // ì„¸ì…˜ ë°ì´í„° ì €ì¥
        const sessionData = {
          image: currentImage,
          conversationHistory: conversationHistory,
          duration: Date.now() - startTime,
          timestamp: new Date().toISOString(),
        };

        localStorage.setItem("sessionData", JSON.stringify(sessionData));

        // í‰ê°€ í˜ì´ì§€ë¡œ ì´ë™
        window.location.href = "/evaluation";
      }

      // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
      window.addEventListener("beforeunload", () => {
        if (timerInterval) {
          clearInterval(timerInterval);
        }
        if (socket) {
          socket.disconnect();
        }
      });
    </script>
  </body>
</html>
