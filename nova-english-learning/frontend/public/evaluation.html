<!doctype html>
<html>
  <head>
    <title>SPEAK-SEE-PIC! - Evaluation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/sky-theme.css" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: 
          radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.3) 0%, transparent 60%),
          radial-gradient(circle at 80% 20%, rgba(255, 223, 0, 0.12) 0%, transparent 50%),
          radial-gradient(circle at 40% 40%, rgba(135, 206, 235, 0.22) 0%, transparent 50%),
          linear-gradient(180deg, #87CEEB 0%, #E0F6FF 50%, #B0E0E6 100%);
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
      }

      body::before {
        content: '';
        position: fixed;
        top: -20%;
        left: -20%;
        width: 140%;
        height: 140%;
        background: 
          radial-gradient(circle 170px at 75% 25%, rgba(255, 223, 0, 0.35) 0%, rgba(255, 255, 255, 0.2) 30%, transparent 70%),
          radial-gradient(circle 110px at 25% 45%, rgba(255, 255, 255, 0.65) 0%, transparent 60%),
          radial-gradient(circle 85px at 65% 75%, rgba(255, 255, 255, 0.45) 0%, transparent 50%);
        pointer-events: none;
        z-index: -1;
        animation: sunlight-float 24s ease-in-out infinite;
      }

      @keyframes sunlight-float {
        0%, 100% { 
          transform: translateX(0px) translateY(0px);
          opacity: 0.6;
        }
        50% { 
          transform: translateX(14px) translateY(-9px);
          opacity: 0.9;
        }
      }

      .loading-spinner {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(135, 206, 235, 0.2);
        border-top: 4px solid #87CEEB;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
        box-shadow: 0 0 20px rgba(135, 206, 235, 0.3);
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .loading-text {
        color: #4682B4;
        font-size: 18px;
        font-weight: 600;
        text-shadow: 0 2px 4px rgba(135, 206, 235, 0.3);
      }

      .main-content {
        display: none;
      }

      .header {
        background: transparent;
        padding: 20px 0;
        margin-bottom: 30px;
        position: relative;
        z-index: 10;
      }

      .header-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        position: relative;
      }
      
      .logo::before {
        content: 'â˜';
        position: absolute;
        left: -15px;
        top: 5px;
        font-size: 20px;
        color: rgba(255, 255, 255, 0.8);
        animation: cloud-float 6s ease-in-out infinite;
      }
      
      .logo::after {
        content: 'âœ¦';
        position: absolute;
        right: -12px;
        top: 2px;
        font-size: 16px;
        color: rgba(255, 255, 255, 0.9);
        animation: star-twinkle 3s ease-in-out infinite;
      }
      
      .logo h1 {
        background: linear-gradient(135deg, #E0F6FF 0%, #87CEEB 50%, #4682B4 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-size: 24px;
        font-weight: 700;
        letter-spacing: 1px;
        text-shadow: 
          0 0 15px rgba(255, 255, 255, 0.5),
          0 0 30px rgba(135, 206, 235, 0.3);
        animation: logo-glow 5s ease-in-out infinite;
      }
      
      @keyframes cloud-float {
        0%, 100% { transform: translateY(0px) translateX(0px); }
        50% { transform: translateY(-6px) translateX(2px); }
      }
      
      @keyframes star-twinkle {
        0%, 100% { opacity: 0.6; transform: scale(1); }
        50% { opacity: 1; transform: scale(1.2); }
      }
      
      @keyframes logo-glow {
        0%, 100% { 
          text-shadow: 
            0 0 15px rgba(255, 255, 255, 0.5),
            0 0 30px rgba(135, 206, 235, 0.3);
        }
        50% { 
          text-shadow: 
            0 0 25px rgba(255, 255, 255, 0.7),
            0 0 50px rgba(135, 206, 235, 0.5);
        }
      }

      .session-info {
        color: #64748b;
        font-size: 14px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
      }

      .page-title {
        text-align: center;
        margin-bottom: 40px;
      }

      .page-title h2 {
        font-size: 32px;
        color: #1e293b;
        margin-bottom: 10px;
      }

      .page-title p {
        font-size: 18px;
        color: #64748b;
      }

      .image-comparison-section {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.4);
        border-radius: 25px;
        padding: 24px;
        box-shadow: 0 8px 32px rgba(135, 206, 235, 0.3);
        margin-bottom: 40px;
        position: relative;
        z-index: 10;
      }

      .images-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 20px;
      }

      .overall-performance {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.4);
        border-radius: 25px;
        padding: 24px;
        box-shadow: 0 8px 32px rgba(135, 206, 235, 0.3);
        margin-bottom: 40px;
        position: relative;
        z-index: 10;
      }

      .image-comparison {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      }

      .section-title {
        font-size: 20px;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 20px;
        text-align: center;
      }

      .image-container {
        position: relative;
        margin-bottom: 15px;
      }

      .comparison-image {
        width: 100%;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .image-label {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
      }

      .similarity-score {
        text-align: center;
        margin-top: 15px;
        padding: 15px;
        background: #f8fafc;
        border-radius: 8px;
      }

      .score-value {
        font-size: 24px;
        font-weight: 700;
        color: #667eea;
        margin-bottom: 5px;
      }

      .score-label {
        font-size: 14px;
        color: #64748b;
      }

      .evaluation-results {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      }

      .overall-score {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
        background: 
          radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.8) 0%, transparent 30%),
          radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.6) 0%, transparent 25%),
          radial-gradient(circle at 60% 40%, rgba(255, 255, 255, 0.4) 0%, transparent 20%),
          linear-gradient(135deg, #E0F6FF 0%, #87CEEB 50%, #4682B4 100%);
        border-radius: 20px;
        color: white;
        box-shadow: 
          0 8px 25px rgba(135, 206, 235, 0.4),
          0 0 20px rgba(255, 255, 255, 0.3),
          inset 0 0 30px rgba(255, 255, 255, 0.2);
        position: relative;
        overflow: hidden;
      }
      
      .overall-score::before {
        content: 'âœ¦';
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 16px;
        color: rgba(255, 255, 255, 0.8);
        animation: star-twinkle 3s ease-in-out infinite;
      }
      
      .overall-score::after {
        content: 'â˜';
        position: absolute;
        bottom: 15px;
        left: 20px;
        font-size: 18px;
        color: rgba(255, 255, 255, 0.7);
        animation: cloud-float 6s ease-in-out infinite;
      }
      
      @keyframes star-twinkle {
        0%, 100% { opacity: 0.6; transform: scale(1); }
        50% { opacity: 1; transform: scale(1.2); }
      }
      
      @keyframes cloud-float {
        0%, 100% { transform: translateY(0px) translateX(0px); }
        50% { transform: translateY(-3px) translateX(2px); }
      }

      .overall-score-value {
        font-size: 48px;
        font-weight: 700;
        margin-bottom: 5px;
      }

      .overall-score-label {
        font-size: 16px;
        opacity: 0.9;
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 30px;
      }

      .metric-card {
        text-align: center;
        padding: 20px;
        background: #f8fafc;
        border-radius: 12px;
      }

      .metric-icon {
        font-size: 32px;
        margin-bottom: 10px;
      }

      .metric-value {
        font-size: 20px;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 5px;
      }

      .metric-label {
        font-size: 14px;
        color: #64748b;
      }

      .metric-bar {
        width: 100%;
        height: 8px;
        background: #e2e8f0;
        border-radius: 4px;
        margin-top: 8px;
        overflow: hidden;
      }

      .metric-fill {
        height: 100%;
        background: linear-gradient(90deg, #10b981, #059669);
        border-radius: 4px;
        transition: width 0.8s ease;
      }

      .feedback-section {
        margin-top: 30px;
      }

      .feedback-tabs {
        display: flex;
        margin-bottom: 20px;
        background: #f1f5f9;
        border-radius: 8px;
        padding: 4px;
      }

      .feedback-tab {
        flex: 1;
        padding: 12px;
        text-align: center;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .feedback-tab.active {
        background: white;
        color: #667eea;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .feedback-content {
        display: none;
      }

      .feedback-content.active {
        display: block;
      }

      .feedback-list {
        list-style: none;
      }

      .feedback-item {
        padding: 12px 0;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: flex-start;
        gap: 12px;
      }

      .feedback-item:last-child {
        border-bottom: none;
      }

      .feedback-icon {
        font-size: 16px;
        margin-top: 2px;
      }

      .feedback-text {
        flex: 1;
        line-height: 1.5;
        color: #374151;
      }

      .actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 40px;
      }

      .action-btn {
        padding: 15px 30px;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
      }

      .primary-btn {
        background: linear-gradient(135deg, #87CEEB 0%, #4682B4 100%);
        color: white;
        position: relative;
        overflow: hidden;
      }

      .primary-btn:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 
          0 12px 35px rgba(135, 206, 235, 0.5),
          0 0 25px rgba(135, 206, 235, 0.4);
      }
      
      .primary-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent 0%,
          rgba(255, 255, 255, 0.3) 50%,
          transparent 100%
        );
        animation: shimmer-sweep 3s ease-in-out infinite;
      }
      
      @keyframes shimmer-sweep {
        0% { left: -100%; }
        100% { left: 100%; }
      }

      .secondary-btn {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.8) 0%, rgba(248, 248, 255, 0.7) 100%);
        color: #4682B4;
        border: 2px solid rgba(135, 206, 235, 0.3);
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
      }

      .secondary-btn:hover {
        background: linear-gradient(135deg, #B0E0E6 0%, #87CEEB 100%);
        color: white;
        transform: translateY(-2px);
        box-shadow: 
          0 8px 25px rgba(135, 206, 235, 0.4),
          0 0 15px rgba(135, 206, 235, 0.3);
      }
      
      .secondary-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent 0%,
          rgba(255, 255, 255, 0.3) 50%,
          transparent 100%
        );
        transition: left 0.6s;
      }
      
      .secondary-btn:hover::before {
        left: 100%;
      }

      .response-analysis {
        background: linear-gradient(135deg, #F0F8FF 0%, #E0F6FF 100%);
        border-radius: 20px;
        padding: 40px;
        margin-bottom: 40px;
        box-shadow: 0 8px 32px rgba(135, 206, 235, 0.2);
      }

      .analysis-header {
        text-align: center;
        margin-bottom: 40px;
      }

      .analysis-title {
        font-size: 28px;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 10px;
        background: linear-gradient(135deg, #87CEEB 0%, #4682B4 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .analysis-subtitle {
        font-size: 16px;
        color: #64748b;
      }

      .analysis-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
      }

      .user-responses,
      .model-answers {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(102, 126, 234, 0.1);
        transition: all 0.3s ease;
      }

      .user-responses:hover,
      .model-answers:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
      }

      .analysis-section-title {
        font-size: 20px;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .title-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
      }

      .user-icon {
        background: linear-gradient(135deg, #87CEEB 0%, #4682B4 100%);
        color: white;
      }

      .model-icon {
        background: linear-gradient(135deg, #87CEEB 0%, #4682B4 100%);
        color: white;
      }

      .response-content {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 16px;
        padding: 25px;
        margin-bottom: 25px;
        max-height: 350px;
        overflow-y: auto;
        border: 1px solid #e2e8f0;
      }

      .user-message {
        background: linear-gradient(135deg, #87CEEB 0%, #4682B4 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 18px;
        margin-bottom: 12px;
        font-size: 14px;
        line-height: 1.5;
        box-shadow: 0 4px 12px rgba(135, 206, 235, 0.3);
        position: relative;
      }

      .user-message::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.2) 0%,
          transparent 100%
        );
        border-radius: 18px;
        pointer-events: none;
      }

      .user-message:last-child {
        margin-bottom: 0;
      }

      .model-content {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border-left: 5px solid #0ea5e9;
        padding: 25px;
        border-radius: 16px;
        margin-bottom: 25px;
        line-height: 1.7;
        color: #0f172a;
        box-shadow: 0 4px 15px rgba(14, 165, 233, 0.1);
        position: relative;
      }

      .model-content::before {
        content: "âœ¨";
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 20px;
        opacity: 0.6;
      }

      .vocabulary-section {
        margin-top: 25px;
      }

      .vocab-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
      }

      .vocab-title {
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
      }

      .vocab-count {
        background: linear-gradient(135deg, #87CEEB 0%, #4682B4 100%);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }

      .vocabulary-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .vocab-tag {
        background: linear-gradient(135deg, #87CEEB 0%, #4682B4 100%);
        color: white;
        padding: 10px 16px;
        border-radius: 25px;
        font-size: 13px;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(135, 206, 235, 0.3);
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .vocab-tag:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(135, 206, 235, 0.4);
      }

      .empty-responses {
        text-align: center;
        color: #64748b;
        font-style: italic;
        padding: 60px 20px;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 16px;
        border: 2px dashed #cbd5e1;
      }

      .empty-icon {
        font-size: 48px;
        margin-bottom: 15px;
        opacity: 0.5;
      }

      @media (max-width: 768px) {
        .images-row {
          grid-template-columns: 1fr;
        }

        .metrics-grid {
          grid-template-columns: 1fr;
        }

        .analysis-grid {
          grid-template-columns: 1fr;
        }

        .actions {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <div class="loading-spinner" id="loading-spinner">
      <div class="spinner"></div>
      <div class="loading-text">Analyzing your performance...</div>
    </div>

    <div class="main-content" id="main-content">
      <div class="header">
        <div class="header-content">
          <div class="logo">
            <h1>SPEAK-SEE-PIC! Evaluation</h1>
          </div>
          <div class="session-info" id="session-info">Session completed</div>
        </div>
      </div>

      <div class="container">
        <div class="page-title">
          <h2>Your Learning Session Results</h2>
          <p>
            Here's how well you described the image and areas for improvement
          </p>
        </div>

        <div class="image-comparison-section">
          <div class="section-title">Image Comparison</div>
          <div class="images-row">
            <div class="image-container">
              <img
                id="original-image"
                class="comparison-image"
                src=""
                alt="Original image"
              />
              <div class="image-label">Original Image</div>
            </div>

            <div class="image-container">
              <img
                id="generated-image"
                class="comparison-image"
                src=""
                alt="Generated image"
              />
              <div class="image-label">AI Generated from Your Description</div>
            </div>
          </div>

          <div class="similarity-score">
            <div class="score-value" id="similarity-score">85%</div>
            <div class="score-label">Similarity Score</div>
          </div>
        </div>

        <div class="overall-performance">
          <div class="section-title">Overall Performance Report</div>

          <div class="overall-score">
            <div class="overall-score-value" id="overall-score">B+</div>
            <div class="overall-score-label">Overall Performance</div>
          </div>

          <div class="metrics-grid">
            <div class="metric-card">
              <div class="metric-icon">ğŸ¯</div>
              <div class="metric-value" id="accuracy-score">85</div>
              <div class="metric-label">Accuracy</div>
              <div class="metric-bar">
                <div
                  class="metric-fill"
                  id="accuracy-bar"
                  style="width: 0%"
                ></div>
              </div>
            </div>

            <div class="metric-card">
              <div class="metric-icon">ğŸ“Š</div>
              <div class="metric-value" id="completeness-score">75</div>
              <div class="metric-label">Completeness</div>
              <div class="metric-bar">
                <div
                  class="metric-fill"
                  id="completeness-bar"
                  style="width: 0%"
                ></div>
              </div>
            </div>

            <div class="metric-card">
              <div class="metric-icon">ğŸ“š</div>
              <div class="metric-value" id="vocabulary-score">80</div>
              <div class="metric-label">Vocabulary</div>
              <div class="metric-bar">
                <div
                  class="metric-fill"
                  id="vocabulary-bar"
                  style="width: 0%"
                ></div>
              </div>
            </div>
          </div>

          <div class="feedback-section">
            <div class="feedback-tabs">
              <div
                class="feedback-tab active"
                onclick="showFeedback('strengths')"
              >
                âœ… Strengths
              </div>
              <div class="feedback-tab" onclick="showFeedback('improvements')">
                ğŸ“ˆ Improvements
              </div>
              <div class="feedback-tab" onclick="showFeedback('alternatives')">
                ğŸ’¡ Alternatives
              </div>
            </div>

            <div id="strengths" class="feedback-content active">
              <ul class="feedback-list" id="strengths-list">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
              </ul>
            </div>

            <div id="improvements" class="feedback-content">
              <ul class="feedback-list" id="improvements-list">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
              </ul>
            </div>

            <div id="alternatives" class="feedback-content">
              <ul class="feedback-list" id="alternatives-list">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
              </ul>
            </div>
          </div>
        </div>

        <div class="response-analysis">
        <div class="analysis-header">
          <h3 class="analysis-title">Detailed Analysis Report</h3>
          <p class="analysis-subtitle">
            Compare your responses with the model answer and expand your
            vocabulary
          </p>
        </div>

        <div class="analysis-grid">
          <div class="user-responses">
            <div class="analysis-section-title">
              <div class="title-icon user-icon">ğŸ“</div>
              <span>Your Responses</span>
            </div>
            <div class="response-content" id="user-responses">
              <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
            </div>
          </div>

          <div class="model-answers">
            <div class="analysis-section-title">
              <div class="title-icon model-icon">âœ¨</div>
              <span>Model Answer</span>
            </div>
            <div class="model-content" id="model-description">
              <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
            </div>

            <div class="vocabulary-section">
              <div class="vocab-header">
                <div class="title-icon model-icon">ğŸ¯</div>
                <span class="vocab-title">Suggested Vocabulary</span>
                <span class="vocab-count" id="vocab-count">0 words</span>
              </div>
              <div class="vocabulary-tags" id="vocabulary-tags">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
              </div>
            </div>
          </div>
        </div>

        <div class="actions">
        <a href="/study" class="action-btn primary-btn">
          <span style="margin-right: 8px; font-size: 18px; filter: drop-shadow(0 0 5px rgba(255,255,255,0.8));">âœ¨</span> Try Another Image
        </a>
        <a href="/categories" class="action-btn secondary-btn">
          <span style="margin-right: 8px; font-size: 18px;">ğŸŒˆ</span> Choose Different Category
        </a>
        <a href="/categories" class="action-btn secondary-btn">
          <span style="margin-right: 8px; font-size: 18px;">â˜ï¸</span> Back to Home
        </a>
      </div>
    </div>

    <script src="/js/light-cascade.js"></script>
    <script>
      let sessionData = null;
      let evaluation = null;

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
      document.addEventListener("DOMContentLoaded", () => {
        // ë¡œê·¸ì¸ í™•ì¸
        const user = JSON.parse(localStorage.getItem("user") || "null");
        if (!user) {
          window.location.href = "/login";
          return;
        }

        // ì„¸ì…˜ ë°ì´í„° ë¡œë“œ
        sessionData = JSON.parse(localStorage.getItem("sessionData") || "null");
        if (!sessionData) {
          window.location.href = "/categories";
          return;
        }

        // 3ì´ˆ í›„ ìŠ¤í”¼ë„ˆ ìˆ¨ê¸°ê³  ë©”ì¸ ì½˜í…ì¸  í‘œì‹œ
        setTimeout(() => {
          document.getElementById("loading-spinner").style.display = "none";
          document.getElementById("main-content").style.display = "block";

          // í‰ê°€ ìƒì„± ë° í‘œì‹œ
          generateEvaluation().then(() => {
            displayResults();
          });
        }, 5000);
      });

      async function generateEvaluation() {
        try {
          // ì‚¬ìš©ì ë©”ì‹œì§€ë§Œ ì¶”ì¶œ
          const userMessages = sessionData.conversationHistory
            .filter((msg) => msg.role === "user")
            .map((msg) => msg.message);

          console.log("Evaluating with API:", {
            imageId: sessionData.image.imageId,
            userMessages: userMessages,
            messageCount: userMessages.length,
          });

          // í‰ê°€ API í˜¸ì¶œ
          const response = await fetch("/api/evaluate", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              imageId: sessionData.image.imageId,
              userMessages: userMessages,
              conversationHistory: sessionData.conversationHistory,
            }),
          });

          const result = await response.json();

          if (result.success) {
            const data = result.data;

            evaluation = {
              overallScore: data.totalScore,
              overallGrade: getGrade(data.totalScore),
              accuracy: data.breakdown.accuracy,
              completeness: data.breakdown.completeness,
              vocabulary: data.breakdown.vocabulary,
              detail: data.breakdown.detail,
              similarityScore: Math.min(
                95,
                Math.max(60, data.breakdown.completeness)
              ),

              strengths: data.feedback.strengths || [],
              improvements: data.feedback.improvements || [],
              alternatives: data.feedback.alternatives || [],
              overallFeedback: data.feedback.overall || "",

              userMessageCount: data.userMessageCount,
            };

            console.log("Evaluation completed:", evaluation);
          } else {
            throw new Error(result.error || "Evaluation failed");
          }
        } catch (error) {
          console.error("Error generating evaluation:", error);

          // ì‚¬ìš©ì ë©”ì‹œì§€ ê°œìˆ˜ í™•ì¸
          const userMessageCount = sessionData.conversationHistory.filter(
            (msg) => msg.role === "user"
          ).length;

          // í´ë°±: ê¸°ë³¸ í‰ê°€ ìƒì„±
          const improvements = ["ë” êµ¬ì²´ì ì¸ ì„¸ë¶€ì‚¬í•­ì„ í¬í•¨í•´ë³´ì„¸ìš”"];

          // ì‚¬ìš©ì ë‹µë³€ì´ 5ê°œ ì´í•˜ì¼ ë•Œ ì¶”ê°€ í”¼ë“œë°±
          if (userMessageCount <= 5) {
            improvements.unshift(
              `ë” ë§ì€ ë‹µë³€ì´ í•„ìš”í•©ë‹ˆë‹¤. í˜„ì¬ ${userMessageCount}ê°œì˜ ë‹µë³€ë§Œ ì œê³µí–ˆìŠµë‹ˆë‹¤. ìµœì†Œ 8-10ê°œì˜ ë‹µë³€ìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ ìì„¸íˆ ì„¤ëª…í•´ë³´ì„¸ìš”`
            );
            improvements.push(
              "ëŒ€í™”ì— ë” ì ê·¹ì ìœ¼ë¡œ ì°¸ì—¬í•˜ê³  ê¸´ ë¬¸ì¥ìœ¼ë¡œ ë‹µë³€í•´ë³´ì„¸ìš”"
            );
          }

          evaluation = {
            overallScore: userMessageCount <= 5 ? 65 : 75,
            overallGrade: userMessageCount <= 5 ? "C+" : "B",
            accuracy: userMessageCount <= 5 ? 65 : 75,
            completeness: userMessageCount <= 5 ? 60 : 70,
            vocabulary: userMessageCount <= 5 ? 70 : 80,
            detail: userMessageCount <= 5 ? 65 : 75,
            similarityScore: userMessageCount <= 5 ? 70 : 80,
            strengths:
              userMessageCount <= 5
                ? ["ì˜ì–´ë¡œ ëŒ€í™”ë¥¼ ì‹œë„í–ˆìŠµë‹ˆë‹¤", "ê¸°ë³¸ì ì¸ ë¬˜ì‚¬ë¥¼ ì œê³µí–ˆìŠµë‹ˆë‹¤"]
                : [
                    "ëŒ€í™”ì— ì ê·¹ì ìœ¼ë¡œ ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤",
                    "ë‹¤ì–‘í•œ í‘œí˜„ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤",
                  ],
            improvements: improvements,
            alternatives: [
              "ë” ë‹¤ì–‘í•œ ì–´íœ˜ë¥¼ ì‚¬ìš©í•´ë³´ì„¸ìš”",
              "ê°ì •ì´ë‚˜ ë¶„ìœ„ê¸°ë„ í‘œí˜„í•´ë³´ì„¸ìš”",
            ],
            overallFeedback:
              userMessageCount <= 5
                ? "ë” ë§ì€ ëŒ€í™” ì°¸ì—¬ì™€ ìì„¸í•œ ì„¤ëª…ì´ í•„ìš”í•©ë‹ˆë‹¤"
                : "ì¢‹ì€ ì°¸ì—¬ë„ë¥¼ ë³´ì˜€ìœ¼ë‚˜ ë” êµ¬ì²´ì ì¸ í‘œí˜„ì´ í•„ìš”í•©ë‹ˆë‹¤",
          };
        }
      }

      function getGrade(score) {
        if (score >= 90) return "A+";
        if (score >= 85) return "A";
        if (score >= 80) return "B+";
        if (score >= 75) return "B";
        if (score >= 70) return "C+";
        if (score >= 65) return "C";
        return "D";
      }

      function getDetailLevel(score) {
        if (score >= 80) return "High";
        if (score >= 60) return "Medium";
        return "Low";
      }

      function generatePersonalizedStrengths(userMessages) {
        const strengths = [];
        const allText = userMessages.join(" ").toLowerCase();

        // ìƒ‰ìƒ ì–¸ê¸‰ í™•ì¸ - ê·¼ê±° ì œì‹œ
        const colorMatch = allText.match(
          /\b(red|blue|green|yellow|black|white|brown|gray|pink|purple|orange)\b/
        );
        if (colorMatch) {
          const colorExample = userMessages.find((msg) =>
            msg.toLowerCase().includes(colorMatch[0])
          );
          strengths.push(
            `ìƒ‰ìƒì„ ì •í™•í•˜ê²Œ ì‹ë³„í•˜ê³  í‘œí˜„í–ˆìŠµë‹ˆë‹¤. ë‹µë³€ì—ì„œ "${colorExample}"ë¼ê³  ë§ì”€í•˜ì…¨ëŠ”ë°, ì´ëŠ” ì´ë¯¸ì§€ì˜ ìƒ‰ìƒì„ ì˜ íŒŒì•…í–ˆë‹¤ëŠ” ì¦ê±°ì…ë‹ˆë‹¤.`
          );
        }

        // í¬ê¸°/ìˆ˜ëŸ‰ í‘œí˜„ í™•ì¸ - ê·¼ê±° ì œì‹œ
        const sizeMatch = allText.match(
          /\b(big|small|large|huge|tiny|many|few|several|some)\b/
        );
        if (sizeMatch) {
          const sizeExample = userMessages.find((msg) =>
            msg.toLowerCase().includes(sizeMatch[0])
          );
          strengths.push(
            `í¬ê¸°ë‚˜ ìˆ˜ëŸ‰ì„ ì ì ˆíˆ í‘œí˜„í–ˆìŠµë‹ˆë‹¤. "${sizeExample}"ë¼ëŠ” ë‹µë³€ì—ì„œ ì‚¬ë¬¼ì˜ í¬ê¸°ë‚˜ ì–‘ì„ êµ¬ì²´ì ìœ¼ë¡œ ë¬˜ì‚¬í•˜ë ¤ëŠ” ë…¸ë ¥ì´ ë³´ì…ë‹ˆë‹¤.`
          );
        }

        // ìœ„ì¹˜/ê³µê°„ í‘œí˜„ í™•ì¸ - ê·¼ê±° ì œì‹œ
        const locationMatch = allText.match(
          /\b(on|in|under|behind|front|next|beside|near|far)\b/
        );
        if (locationMatch) {
          const locationExample = userMessages.find((msg) =>
            msg.toLowerCase().includes(locationMatch[0])
          );
          strengths.push(
            `ê³µê°„ì  ê´€ê³„ë¥¼ ì˜ íŒŒì•…í•˜ê³  ì„¤ëª…í–ˆìŠµë‹ˆë‹¤. "${locationExample}"ì—ì„œ ì‚¬ë¬¼ë“¤ì˜ ìœ„ì¹˜ ê´€ê³„ë¥¼ ì •í™•íˆ ì„¤ëª…í•˜ê³  ìˆìŠµë‹ˆë‹¤.`
          );
        }

        // ê°ì •/ë¶„ìœ„ê¸° í‘œí˜„ í™•ì¸ - ê·¼ê±° ì œì‹œ
        const moodMatch = allText.match(
          /\b(happy|sad|busy|quiet|peaceful|crowded|comfortable|warm|cozy)\b/
        );
        if (moodMatch) {
          const moodExample = userMessages.find((msg) =>
            msg.toLowerCase().includes(moodMatch[0])
          );
          strengths.push(
            `ë¶„ìœ„ê¸°ë‚˜ ê°ì •ì„ ì˜ í‘œí˜„í–ˆìŠµë‹ˆë‹¤. "${moodExample}"ë¼ëŠ” ë‹µë³€ì—ì„œ ë‹¨ìˆœí•œ ë¬˜ì‚¬ë¥¼ ë„˜ì–´ ê°ì •ì  ìš”ì†Œê¹Œì§€ í¬í•¨ì‹œì¼°ìŠµë‹ˆë‹¤.`
          );
        }

        // í–‰ë™/ë™ì‘ í‘œí˜„ í™•ì¸ - ê·¼ê±° ì œì‹œ
        const actionMatch = allText.match(
          /\b(sitting|standing|walking|working|talking|eating|drinking|reading|typing)\b/
        );
        if (actionMatch) {
          const actionExample = userMessages.find((msg) =>
            msg.toLowerCase().includes(actionMatch[0])
          );
          strengths.push(
            `ì¸ë¬¼ë“¤ì˜ í–‰ë™ì„ êµ¬ì²´ì ìœ¼ë¡œ ë¬˜ì‚¬í–ˆìŠµë‹ˆë‹¤. "${actionExample}"ì—ì„œ ì‚¬ëŒë“¤ì´ ë¬´ì—‡ì„ í•˜ê³  ìˆëŠ”ì§€ ìƒìƒí•˜ê²Œ í‘œí˜„í–ˆìŠµë‹ˆë‹¤.`
          );
        }

        // ë¬¸ì¥ ê¸¸ì´ ë¶„ì„ - ê·¼ê±° ì œì‹œ
        const avgLength =
          userMessages.reduce((sum, msg) => sum + msg.split(" ").length, 0) /
          userMessages.length;
        if (avgLength > 8) {
          const longestMsg = userMessages.reduce((longest, current) =>
            current.split(" ").length > longest.split(" ").length
              ? current
              : longest
          );
          strengths.push(
            `ì™„ì „í•œ ë¬¸ì¥ìœ¼ë¡œ ìì„¸íˆ ì„¤ëª…í•˜ë ¤ê³  ë…¸ë ¥í–ˆìŠµë‹ˆë‹¤. íŠ¹íˆ "${longestMsg}"ì™€ ê°™ì€ ë‹µë³€ì—ì„œ í‰ê·  ${Math.round(avgLength)}ë‹¨ì–´ë¡œ êµ¬ì„±ëœ ì™„ì„±ë„ ë†’ì€ ë¬¸ì¥ì„ êµ¬ì‚¬í–ˆìŠµë‹ˆë‹¤.`
          );
        }

        // ë‹¤ì–‘í•œ ì–´íœ˜ ì‚¬ìš© í™•ì¸ - ê·¼ê±° ì œì‹œ
        const uniqueWords = [
          ...new Set(allText.split(" ").filter((word) => word.length > 3)),
        ];
        if (uniqueWords.length > 15) {
          strengths.push(
            `ë‹¤ì–‘í•œ ì–´íœ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ í‘œí˜„ë ¥ì„ ë³´ì˜€ìŠµë‹ˆë‹¤. ì´ ${uniqueWords.length}ê°œì˜ ì„œë¡œ ë‹¤ë¥¸ ë‹¨ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°˜ë³µì„ í”¼í•˜ê³  í’ë¶€í•œ í‘œí˜„ì„ êµ¬ì‚¬í–ˆìŠµë‹ˆë‹¤.`
          );
        }

        // ê¸°ë³¸ ê°•ì  - ê·¼ê±° ì œì‹œ
        if (userMessages.length > 0) {
          strengths.push(
            `ì˜ì–´ë¡œ ëŒ€í™”ë¥¼ ì‹œë„í•˜ëŠ” ì ê·¹ì ì¸ ìì„¸ë¥¼ ë³´ì˜€ìŠµë‹ˆë‹¤. ì´ ${userMessages.length}ê°œì˜ ì‘ë‹µì„ í†µí•´ í•™ìŠµì— ëŒ€í•œ ì˜ì§€ì™€ ì°¸ì—¬ë„ë¥¼ ë³´ì—¬ì£¼ì—ˆìŠµë‹ˆë‹¤.`
          );
        }

        return strengths.slice(0, 6); // ìµœëŒ€ 6ê°œ
      }

      function generatePersonalizedImprovements(userMessages) {
        const improvements = [];
        const allText = userMessages.join(" ").toLowerCase();
        const avgLength =
          userMessages.reduce((sum, msg) => sum + msg.split(" ").length, 0) /
          userMessages.length;

        // ë‹µë³€ ê°œìˆ˜ ë¶€ì¡± í™•ì¸ - ìµœìš°ì„  í”¼ë“œë°± (5ê°œ ì´í•˜ì¼ ë•Œ)
        if (userMessages.length <= 5) {
          improvements.push(
            `ë” ë§ì€ ë‹µë³€ì´ í•„ìš”í•©ë‹ˆë‹¤. í˜„ì¬ ${userMessages.length}ê°œì˜ ë‹µë³€ë§Œ ì œê³µí•˜ì…¨ëŠ”ë°, ì´ëŠ” ì´ë¯¸ì§€ë¥¼ ì¶©ë¶„íˆ ì„¤ëª…í•˜ê¸°ì— ë¶€ì¡±í•©ë‹ˆë‹¤. ì´ë¯¸ì§€ì˜ ì„¸ë¶€ì‚¬í•­ì„ ë” ìì„¸íˆ ê´€ì°°í•˜ê³  ìµœì†Œ 8-10ê°œì˜ ë‹µë³€ìœ¼ë¡œ í™•ì¥í•´ë³´ì„¸ìš”. ì˜ˆë¥¼ ë“¤ì–´, ìƒ‰ìƒ, ìœ„ì¹˜, ì‚¬ëŒë“¤ì˜ í–‰ë™, ë¬¼ê±´ì˜ íŠ¹ì§• ë“±ì„ ê°ê° ë³„ë„ë¡œ ì„¤ëª…í•´ë³´ì„¸ìš”.`
          );
          improvements.push(
            `ëŒ€í™”ì— ë” ì ê·¹ì ìœ¼ë¡œ ì°¸ì—¬í•´ë³´ì„¸ìš”. í˜„ì¬ ë‹µë³€ ìˆ˜(${userMessages.length}ê°œ)ë¡œëŠ” ì˜ì–´ ì‹¤ë ¥ í–¥ìƒì— í•œê³„ê°€ ìˆìŠµë‹ˆë‹¤. AIì™€ ë” ë§ì€ ëŒ€í™”ë¥¼ ë‚˜ëˆ„ë©° ë‹¤ì–‘í•œ í‘œí˜„ì„ ì—°ìŠµí•´ë³´ì„¸ìš”.`
          );
        }

        // ì§§ì€ ë‹µë³€ ê°œì„  - ê·¼ê±° ì œì‹œ
        const shortAnswers = userMessages.filter(
          (msg) => msg.split(" ").length <= 3
        );
        if (avgLength < 5 && shortAnswers.length > 0) {
          improvements.push(
            `ë” ê¸´ ë¬¸ì¥ìœ¼ë¡œ ìì„¸íˆ ì„¤ëª…í•´ë³´ì„¸ìš”. í˜„ì¬ í‰ê·  ${Math.round(avgLength)}ë‹¨ì–´ë¡œ ë‹µë³€í•˜ê³  ìˆëŠ”ë°, "${shortAnswers[0]}"ì™€ ê°™ì€ ì§§ì€ ë‹µë³€ë³´ë‹¤ëŠ” "${shortAnswers[0]} with detailed characteristics and specific features"ì²˜ëŸ¼ êµ¬ì²´ì ì¸ ì„¤ëª…ì„ ì¶”ê°€í•´ë³´ì„¸ìš”.`
          );
        }

        // ìƒ‰ìƒ í‘œí˜„ ë¶€ì¡± - ê·¼ê±° ì œì‹œ
        if (
          !/\b(red|blue|green|yellow|black|white|brown|gray|pink|purple|orange)\b/.test(
            allText
          )
        ) {
          const totalResponses = userMessages.length;
          improvements.push(
            `ìƒ‰ìƒ í‘œí˜„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ${totalResponses}ê°œì˜ ë‹µë³€ ëª¨ë‘ì—ì„œ ìƒ‰ìƒì„ ì–¸ê¸‰í•˜ì§€ ì•Šìœ¼ì…¨ìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ì—ì„œ ë³´ì´ëŠ” ìƒ‰ìƒë“¤ì„ 'bright blue', 'warm yellow', 'deep red' ë“±ìœ¼ë¡œ êµ¬ì²´ì ìœ¼ë¡œ í‘œí˜„í•´ë³´ì„¸ìš”.`
          );
        }

        // ê°ì •/ë¶„ìœ„ê¸° í‘œí˜„ ë¶€ì¡± - ê·¼ê±° ì œì‹œ
        if (
          !/\b(happy|sad|busy|quiet|peaceful|crowded|comfortable|warm|cozy|relaxed|energetic)\b/.test(
            allText
          )
        ) {
          const neutralAnswers = userMessages.filter((msg) => msg.length > 5);
          if (neutralAnswers.length > 0) {
            improvements.push(
              `ë¶„ìœ„ê¸°ë‚˜ ê°ì • í‘œí˜„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. "${neutralAnswers[0]}"ì™€ ê°™ì€ ë‹µë³€ì—ì„œ ë‹¨ìˆœí•œ ì‚¬ì‹¤ ë‚˜ì—´ì„ ë„˜ì–´ 'cozy', 'peaceful', 'busy' ê°™ì€ ê°ì •ì  ìš”ì†Œë¥¼ ì¶”ê°€í•˜ë©´ ë” í’ë¶€í•œ í‘œí˜„ì´ ë©ë‹ˆë‹¤.`
            );
          } else {
            improvements.push(
              `ë¶„ìœ„ê¸°ë‚˜ ê°ì • í‘œí˜„ì´ ì „í˜€ ì—†ìŠµë‹ˆë‹¤. ëª¨ë“  ë‹µë³€ì´ ê°ê´€ì  ì‚¬ì‹¤ë§Œ ë‚˜ì—´í•˜ê³  ìˆì–´ ì•„ì‰½ìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ì—ì„œ ëŠê»´ì§€ëŠ” ë¶„ìœ„ê¸°ë¥¼ 'cozy', 'peaceful', 'busy' ê°™ì€ ë‹¨ì–´ë¡œ í‘œí˜„í•´ë³´ì„¸ìš”.`
            );
          }
        }

        // ìœ„ì¹˜ í‘œí˜„ ë¶€ì¡± - ê·¼ê±° ì œì‹œ
        if (
          !/\b(on|in|under|behind|front|next|beside|near|far|left|right|center)\b/.test(
            allText
          )
        ) {
          const objectMentions = userMessages.filter((msg) =>
            /\b(table|chair|laptop|cup|book|person|people)\b/.test(
              msg.toLowerCase()
            )
          );
          if (objectMentions.length > 0) {
            improvements.push(
              `ìœ„ì¹˜ ê´€ê³„ ì„¤ëª…ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. "${objectMentions[0]}"ì—ì„œ ì‚¬ë¬¼ë“¤ì„ ì–¸ê¸‰í•˜ì…¨ì§€ë§Œ, ì´ë“¤ì´ ì–´ë””ì— ìœ„ì¹˜í•˜ëŠ”ì§€ 'on the table', 'next to', 'behind' ë“±ìœ¼ë¡œ êµ¬ì²´ì ì¸ ìœ„ì¹˜ë¥¼ ì„¤ëª…í•´ë³´ì„¸ìš”.`
            );
          } else {
            improvements.push(
              `ìœ„ì¹˜ ê´€ê³„ í‘œí˜„ì´ ì „í˜€ ì—†ìŠµë‹ˆë‹¤. ëª¨ë“  ë‹µë³€ì—ì„œ ì‚¬ë¬¼ë“¤ì˜ ê³µê°„ì  ê´€ê³„ë¥¼ ì„¤ëª…í•˜ì§€ ì•Šìœ¼ì…¨ìŠµë‹ˆë‹¤. 'on the table', 'next to the window' ë“±ìœ¼ë¡œ ìœ„ì¹˜ë¥¼ ëª…í™•íˆ í•´ë³´ì„¸ìš”.`
            );
          }
        }

        // í–‰ë™ ë¬˜ì‚¬ ë¶€ì¡± - ê·¼ê±° ì œì‹œ
        if (
          !/\b(sitting|standing|walking|working|talking|eating|drinking|reading|typing|smiling)\b/.test(
            allText
          )
        ) {
          const peopleMentions = userMessages.filter((msg) =>
            /\b(people|person|man|woman|student)\b/.test(msg.toLowerCase())
          );
          if (peopleMentions.length > 0) {
            improvements.push(
              `í–‰ë™ ë¬˜ì‚¬ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. "${peopleMentions[0]}"ì—ì„œ ì‚¬ëŒë“¤ì„ ì–¸ê¸‰í•˜ì…¨ì§€ë§Œ, ê·¸ë“¤ì´ ë¬´ì—‡ì„ í•˜ê³  ìˆëŠ”ì§€ 'working', 'typing', 'talking' ë“±ìœ¼ë¡œ êµ¬ì²´ì ì¸ í–‰ë™ì„ ì„¤ëª…í•´ë³´ì„¸ìš”.`
            );
          } else {
            improvements.push(
              `í–‰ë™ ë¬˜ì‚¬ê°€ ì „í˜€ ì—†ìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ ì† ì‚¬ëŒë“¤ì˜ í–‰ë™ì„ 'working', 'talking', 'reading' ë“±ìœ¼ë¡œ ìƒìƒí•˜ê²Œ í‘œí˜„í•´ë³´ì„¸ìš”.`
            );
          }
        }

        // í˜•ìš©ì‚¬ ì‚¬ìš© ë¶€ì¡± - ê·¼ê±° ì œì‹œ
        const adjectives =
          allText.match(
            /\b(big|small|large|beautiful|nice|good|new|old|modern|comfortable)\b/g
          ) || [];
        if (adjectives.length < 3) {
          improvements.push(
            `í˜•ìš©ì‚¬ ì‚¬ìš©ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. í˜„ì¬ ${adjectives.length}ê°œë§Œ ì‚¬ìš©í•˜ì…¨ìŠµë‹ˆë‹¤. ${adjectives.length > 0 ? `ì‚¬ìš©í•œ í˜•ìš©ì‚¬(${adjectives.join(", ")})` : "í˜•ìš©ì‚¬ë¥¼ ì „í˜€ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ì…¨ìŠµë‹ˆë‹¤"}. 'spacious', 'modern', 'comfortable' ë“± ë” ë‹¤ì–‘í•œ í˜•ìš©ì‚¬ë¡œ ë¬˜ì‚¬ë¥¼ í’ë¶€í•˜ê²Œ í•´ë³´ì„¸ìš”.`
          );
        }

        // ë°˜ë³µ í‘œí˜„ í™•ì¸ - ê·¼ê±° ì œì‹œ
        const words = allText.split(" ").filter((word) => word.length > 3);
        const wordCount = {};
        words.forEach((word) => (wordCount[word] = (wordCount[word] || 0) + 1));
        const repeatedWords = Object.keys(wordCount).filter(
          (word) => wordCount[word] > 2
        );
        if (repeatedWords.length > 0) {
          const exampleMsgs = userMessages.filter((msg) =>
            msg.toLowerCase().includes(repeatedWords[0])
          );
          improvements.push(
            `"${repeatedWords[0]}" ë‹¨ì–´ë¥¼ ${wordCount[repeatedWords[0]]}ë²ˆ ë°˜ë³µ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. "${exampleMsgs[0]}"ì™€ "${exampleMsgs[1] || ""}"ì—ì„œ ê°™ì€ ë‹¨ì–´ë¥¼ ë°˜ë³µí•˜ì…¨ëŠ”ë°, ë‹¤ì–‘í•œ ë™ì˜ì–´ë¥¼ ì‚¬ìš©í•˜ë©´ ë” í’ë¶€í•œ í‘œí˜„ì´ ë©ë‹ˆë‹¤.`
          );
        }

        return improvements.slice(0, 6); // ìµœëŒ€ 6ê°œ (ë‹µë³€ ê°œìˆ˜ í”¼ë“œë°± í¬í•¨)
      }

      function generatePersonalizedAlternatives(userMessages) {
        const alternatives = [];
        const allText = userMessages.join(" ").toLowerCase();

        // ì‚¬ìš©ìê°€ ì‹¤ì œ ì‚¬ìš©í•œ ë‹¨ì–´ë“¤ì„ ì°¾ì•„ì„œ ê·¼ê±°ì™€ í•¨ê»˜ ëŒ€ì•ˆ ì œì‹œ

        // 'big' ì‚¬ìš© ë¶„ì„
        const bigUsages = userMessages.filter((msg) =>
          msg.toLowerCase().includes("big")
        );
        if (bigUsages.length > 0) {
          alternatives.push(
            `"big" í‘œí˜„ì„ ê°œì„ í•´ë³´ì„¸ìš”. "${bigUsages[0]}"ì—ì„œ 'big'ì„ ì‚¬ìš©í•˜ì…¨ëŠ”ë°, 'enormous', 'spacious', 'massive' ë“± ë” êµ¬ì²´ì ì¸ í˜•ìš©ì‚¬ë¥¼ ì‚¬ìš©í•˜ë©´ "${bigUsages[0].replace(/\bbig\b/gi, "enormous")}"ì²˜ëŸ¼ ë” ìƒìƒí•œ í‘œí˜„ì´ ë©ë‹ˆë‹¤.`
          );
        }

        // 'nice/good' ì‚¬ìš© ë¶„ì„
        const niceUsages = userMessages.filter((msg) =>
          /\b(nice|good)\b/i.test(msg)
        );
        if (niceUsages.length > 0) {
          const word = niceUsages[0].match(/\b(nice|good)\b/i)[0];
          const enhanced = niceUsages[0]
            .replace(/\bnice\b/gi, "pleasant")
            .replace(/\bgood\b/gi, "excellent");
          alternatives.push(
            `"${word}" í‘œí˜„ì„ ê°œì„ í•´ë³´ì„¸ìš”. "${niceUsages[0]}"ì—ì„œ '${word}'ë¥¼ ì‚¬ìš©í•˜ì…¨ëŠ”ë°, 'pleasant', 'attractive', 'appealing' ë“±ì„ ì‚¬ìš©í•˜ë©´ "${enhanced}"ì²˜ëŸ¼ ë” ì •í™•í•œ í‘œí˜„ì´ ë©ë‹ˆë‹¤.`
          );
        }

        // 'people' ì‚¬ìš© ë¶„ì„
        const peopleUsages = userMessages.filter((msg) =>
          msg.toLowerCase().includes("people")
        );
        if (peopleUsages.length > 0) {
          alternatives.push(
            `"people" í‘œí˜„ì„ ë‹¤ì–‘í™”í•´ë³´ì„¸ìš”. "${peopleUsages[0]}"ì—ì„œ 'people'ì„ ì‚¬ìš©í•˜ì…¨ëŠ”ë°, ìƒí™©ì— ë”°ë¼ 'individuals', 'customers', 'visitors', 'colleagues' ë“± ë” êµ¬ì²´ì ì¸ í‘œí˜„ì„ ì‚¬ìš©í•˜ë©´ "${peopleUsages[0].replace(/\bpeople\b/gi, "individuals")}"ì²˜ëŸ¼ ë” ì •í™•í•´ì§‘ë‹ˆë‹¤.`
          );
        }

        // 'small' ì‚¬ìš© ë¶„ì„
        const smallUsages = userMessages.filter((msg) =>
          msg.toLowerCase().includes("small")
        );
        if (smallUsages.length > 0) {
          alternatives.push(
            `"small" í‘œí˜„ì„ êµ¬ì²´í™”í•´ë³´ì„¸ìš”. "${smallUsages[0]}"ì—ì„œ 'small'ì„ ì‚¬ìš©í•˜ì…¨ëŠ”ë°, 'tiny', 'compact', 'petite', 'miniature' ë“±ì„ ì‚¬ìš©í•˜ë©´ "${smallUsages[0].replace(/\bsmall\b/gi, "compact")}"ì²˜ëŸ¼ ë” ìƒìƒí•œ ë¬˜ì‚¬ê°€ ë©ë‹ˆë‹¤.`
          );
        }

        // 'many' ì‚¬ìš© ë¶„ì„
        const manyUsages = userMessages.filter((msg) =>
          msg.toLowerCase().includes("many")
        );
        if (manyUsages.length > 0) {
          alternatives.push(
            `"many" í‘œí˜„ì„ í’ë¶€í•˜ê²Œ í•´ë³´ì„¸ìš”. "${manyUsages[0]}"ì—ì„œ 'many'ë¥¼ ì‚¬ìš©í•˜ì…¨ëŠ”ë°, 'numerous', 'several', 'countless', 'a variety of' ë“±ì„ ì‚¬ìš©í•˜ë©´ "${manyUsages[0].replace(/\bmany\b/gi, "numerous")}"ì²˜ëŸ¼ ë” ì •êµí•œ í‘œí˜„ì´ ë©ë‹ˆë‹¤.`
          );
        }

        // ë°˜ë³µ ì‚¬ìš©ëœ ë‹¨ì–´ ë¶„ì„
        const words = allText.split(" ").filter((word) => word.length > 3);
        const wordCount = {};
        words.forEach((word) => (wordCount[word] = (wordCount[word] || 0) + 1));
        const repeatedWords = Object.keys(wordCount).filter(
          (word) => wordCount[word] > 2
        );

        if (repeatedWords.length > 0) {
          const word = repeatedWords[0];
          const usageCount = wordCount[word];
          const exampleMsgs = userMessages.filter((msg) =>
            msg.toLowerCase().includes(word)
          );
          alternatives.push(
            `"${word}" ë°˜ë³µ ì‚¬ìš©ì„ ê°œì„ í•´ë³´ì„¸ìš”. ì´ ë‹¨ì–´ë¥¼ ${usageCount}ë²ˆ ì‚¬ìš©í•˜ì…¨ìŠµë‹ˆë‹¤(ì˜ˆ: "${exampleMsgs[0]}", "${exampleMsgs[1] || ""}"). ê°™ì€ ì˜ë¯¸ì˜ ë‹¤ë¥¸ ë‹¨ì–´ë“¤ì„ ì‚¬ìš©í•˜ë©´ ë” ë‹¤ì–‘í•˜ê³  í’ë¶€í•œ í‘œí˜„ì´ ë©ë‹ˆë‹¤.`
          );
        }

        // ê¸°ë³¸ ëŒ€ì•ˆ (ì‚¬ìš©ìê°€ ì‚¬ìš©í•˜ì§€ ì•Šì€ ê²½ìš°)
        if (alternatives.length < 3) {
          const shortestAnswer = userMessages.reduce(
            (shortest, current) =>
              current.length < shortest.length ? current : shortest,
            userMessages[0] || "It's nice"
          );

          if (shortestAnswer && shortestAnswer.split(" ").length <= 3) {
            alternatives.push(
              `ë¬¸ì¥ì„ í™•ì¥í•´ë³´ì„¸ìš”. í˜„ì¬ ê°€ì¥ ì§§ì€ ë‹µë³€ì¸ "${shortestAnswer}"ë¥¼ "${shortestAnswer} with detailed characteristics and specific features"ì²˜ëŸ¼ êµ¬ì²´ì ì¸ ì„¤ëª…ì„ ì¶”ê°€í•˜ë©´ ë” ì™„ì„±ë„ ë†’ì€ ë‹µë³€ì´ ë©ë‹ˆë‹¤.`
            );
          }

          // ì‚¬ìš©í•˜ì§€ ì•Šì€ í‘œí˜„ë“¤ì— ëŒ€í•œ ì œì•ˆ
          if (!/\b(red|blue|green|yellow)\b/.test(allText)) {
            alternatives.push(
              `ìƒ‰ìƒ í‘œí˜„ì„ ì¶”ê°€í•´ë³´ì„¸ìš”. ì „ì²´ ${userMessages.length}ê°œ ë‹µë³€ì—ì„œ ìƒ‰ìƒì„ ì–¸ê¸‰í•˜ì§€ ì•Šìœ¼ì…¨ìŠµë‹ˆë‹¤. 'bright red', 'deep blue', 'warm yellow' ë“±ì˜ ìƒ‰ìƒ í‘œí˜„ì„ ì¶”ê°€í•˜ë©´ ë” ìƒìƒí•œ ë¬˜ì‚¬ê°€ ë©ë‹ˆë‹¤.`
            );
          }

          if (!/\b(peaceful|busy|quiet|cozy)\b/.test(allText)) {
            alternatives.push(
              `ë¶„ìœ„ê¸° í‘œí˜„ì„ ì¶”ê°€í•´ë³´ì„¸ìš”. ì „ì²´ ë‹µë³€ì—ì„œ ë¶„ìœ„ê¸°ë‚˜ ê°ì •ì„ í‘œí˜„í•˜ì§€ ì•Šìœ¼ì…¨ìŠµë‹ˆë‹¤. 'peaceful', 'busy', 'cozy', 'vibrant' ë“±ì˜ ë‹¨ì–´ë¡œ ì´ë¯¸ì§€ì˜ ë¶„ìœ„ê¸°ë¥¼ í‘œí˜„í•´ë³´ì„¸ìš”.`
            );
          }
        }

        return alternatives.slice(0, 6); // ìµœëŒ€ 6ê°œ
      }

      function displayResults() {
        // ì´ë¯¸ì§€ í‘œì‹œ
        document.getElementById("original-image").src = sessionData.image.url;

        // ìƒì„±ëœ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ í‘œì‹œ, ì—†ìœ¼ë©´ í”Œë ˆì´ìŠ¤í™€ë”
        const generatedImg = document.getElementById("generated-image");
        if (sessionData.image.generatedImageUrl) {
          generatedImg.src = sessionData.image.generatedImageUrl;
          generatedImg.style.display = "block";
        } else {
          // ìƒì„±ëœ ì´ë¯¸ì§€ê°€ ì—†ëŠ” ê²½ìš° í”Œë ˆì´ìŠ¤í™€ë” í‘œì‹œ
          generatedImg.style.display = "none";
          const container = generatedImg.parentElement;
          if (!container.querySelector(".no-image-placeholder")) {
            const placeholder = document.createElement("div");
            placeholder.className = "no-image-placeholder";
            placeholder.style.cssText = `
                        width: 100%;
                        height: 200px;
                        background: #f1f5f9;
                        border: 2px dashed #cbd5e1;
                        border-radius: 12px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: #64748b;
                        font-size: 16px;
                        text-align: center;
                    `;
            placeholder.innerHTML =
              "ğŸ¨<br>No AI image was generated<br>during this session";
            container.appendChild(placeholder);
          }
        }

        console.log("Session data image info:", {
          originalUrl: sessionData.image.url,
          generatedUrl: sessionData.image.generatedImageUrl,
          hasGenerated: !!sessionData.image.generatedImageUrl,
        });

        // ì„¸ì…˜ ì •ë³´ í‘œì‹œ
        const duration = Math.floor(sessionData.duration / 1000);
        const minutes = Math.floor(duration / 60);
        const seconds = duration % 60;
        document.getElementById("session-info").textContent =
          `Duration: ${minutes}:${seconds.toString().padStart(2, "0")} | ${sessionData.conversationHistory.length} messages`;

        // ì ìˆ˜ í‘œì‹œ
        document.getElementById("overall-score").textContent =
          evaluation.overallGrade;
        document.getElementById("similarity-score").textContent =
          evaluation.similarityScore + "%";

        // Nova Pro ë©”íŠ¸ë¦­ í‘œì‹œ
        document.getElementById("accuracy-score").textContent =
          evaluation.accuracy;
        document.getElementById("completeness-score").textContent =
          evaluation.completeness;
        document.getElementById("vocabulary-score").textContent =
          evaluation.vocabulary;

        // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì• ë‹ˆë©”ì´ì…˜
        setTimeout(() => {
          document.getElementById("accuracy-bar").style.width =
            evaluation.accuracy + "%";
          document.getElementById("completeness-bar").style.width =
            evaluation.completeness + "%";
          document.getElementById("vocabulary-bar").style.width =
            evaluation.vocabulary + "%";
        }, 500);

        // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ì¶œ
        const userMessages = sessionData.conversationHistory
          .filter((msg) => msg.role === "user")
          .map((msg) => msg.message);

        // ì¦ê±° ê¸°ë°˜ í”¼ë“œë°± í‘œì‹œ (Nova Proì—ì„œ ìƒì„±ëœ ê²½ìš°)
        if (
          evaluation.strengths &&
          evaluation.strengths.length > 0 &&
          evaluation.strengths[0].evidence
        ) {
          displayEvidenceBasedFeedback(
            "strengths-list",
            evaluation.strengths,
            "âœ…"
          );
          displayEvidenceBasedFeedback(
            "improvements-list",
            evaluation.improvements,
            "ğŸ“ˆ"
          );
          displayEvidenceBasedFeedback(
            "alternatives-list",
            evaluation.alternatives,
            "ğŸ’¡"
          );
        } else {
          // í´ë°±: ê°œì¸í™”ëœ í”¼ë“œë°± ìƒì„±
          const personalizedStrengths =
            generatePersonalizedStrengths(userMessages);
          const personalizedImprovements =
            generatePersonalizedImprovements(userMessages);
          const personalizedAlternatives =
            generatePersonalizedAlternatives(userMessages);

          displayFeedbackList("strengths-list", personalizedStrengths, "âœ…");
          displayFeedbackList(
            "improvements-list",
            personalizedImprovements,
            "ğŸ“ˆ"
          );
          displayFeedbackList(
            "alternatives-list",
            personalizedAlternatives,
            "ğŸ’¡"
          );
        }

        // ì‚¬ìš©ì ë‹µë³€ê³¼ ëª¨ë²” ë‹µë³€ í‘œì‹œ
        displayUserResponses();
        displayModelAnswers();
      }

      function displayFeedbackList(containerId, items, icon) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";

        items.forEach((item) => {
          const li = document.createElement("li");
          li.className = "feedback-item";
          li.innerHTML = `
                    <span class="feedback-icon">${icon}</span>
                    <span class="feedback-text">${item}</span>
                `;
          container.appendChild(li);
        });
      }

      function displayEvidenceBasedFeedback(containerId, items, icon) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";

        items.forEach((item) => {
          const li = document.createElement("li");
          li.className = "feedback-item";

          if (typeof item === "object" && item.point && item.evidence) {
            // ì¦ê±° ê¸°ë°˜ í”¼ë“œë°± í˜•ì‹
            li.innerHTML = `
                        <span class="feedback-icon">${icon}</span>
                        <div class="feedback-text">
                            <div style="font-weight: 600; margin-bottom: 4px;">${item.point}</div>
                            <div style="color: #64748b; font-size: 14px; font-style: italic;">${item.evidence}</div>
                        </div>
                    `;
          } else if (typeof item === "object" && item.original && item.better) {
            // ëŒ€ì•ˆ í‘œí˜„ í˜•ì‹
            li.innerHTML = `
                        <span class="feedback-icon">${icon}</span>
                        <div class="feedback-text">
                            <div style="margin-bottom: 8px;">
                                <span style="color: #ef4444; text-decoration: line-through;">â€œ${item.original}â€</span>
                                â†’
                                <span style="color: #10b981; font-weight: 600;">â€œ${item.better}â€</span>
                            </div>
                            <div style="color: #64748b; font-size: 14px;">${item.reason}</div>
                        </div>
                    `;
          } else {
            // ê¸°ë³¸ í˜•ì‹
            li.innerHTML = `
                        <span class="feedback-icon">${icon}</span>
                        <span class="feedback-text">${typeof item === "string" ? item : item.point || item}</span>
                    `;
          }

          container.appendChild(li);
        });
      }

      function displayUserResponses() {
        const container = document.getElementById("user-responses");
        const userMessages = sessionData.conversationHistory
          .filter((msg) => msg.role === "user")
          .map((msg) => msg.message);

        if (userMessages.length === 0) {
          container.innerHTML =
            '<div class="empty-responses"><div class="empty-icon">ğŸ’¬</div>No user responses found.<br>Try speaking more during your next session!</div>';
          return;
        }

        container.innerHTML = userMessages
          .map(
            (message, index) =>
              `<div class="user-message">${index + 1}. ${message}</div>`
          )
          .join("");
      }

      function displayModelAnswers() {
        const descriptionContainer =
          document.getElementById("model-description");
        const vocabularyContainer = document.getElementById("vocabulary-tags");
        const vocabCountContainer = document.getElementById("vocab-count");

        // ëª¨ë²” ë‹µë³€ (ì´ë¯¸ì§€ description)
        descriptionContainer.textContent = sessionData.image.description;

        // ì„ íƒ ê°€ëŠ¥ ì–´íœ˜ (expectedVocabulary)
        const vocabCount = sessionData.image.expectedVocabulary.length;
        vocabCountContainer.textContent = `${vocabCount} words`;

        vocabularyContainer.innerHTML = sessionData.image.expectedVocabulary
          .map((vocab) => `<span class="vocab-tag">${vocab}</span>`)
          .join("");
      }

      function showFeedback(type) {
        // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
        document.querySelectorAll(".feedback-tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        // ëª¨ë“  ì½˜í…ì¸  ìˆ¨ê¸°ê¸°
        document.querySelectorAll(".feedback-content").forEach((content) => {
          content.classList.remove("active");
        });

        // ì„ íƒëœ íƒ­ê³¼ ì½˜í…ì¸  í™œì„±í™”
        event.target.classList.add("active");
        document.getElementById(type).classList.add("active");
      }

      // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì„¸ì…˜ ë°ì´í„° ì •ë¦¬
      window.addEventListener("beforeunload", () => {
        localStorage.removeItem("sessionData");
      });
    </script>
  </body>
</html>
